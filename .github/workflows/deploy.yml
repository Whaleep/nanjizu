name: Deploy to Hostinger

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest

    steps:
      # 1. å–å¾—ç¨‹å¼ç¢¼
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4

      # 2. è¨­å®š Node.js ç’°å¢ƒ
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      # 3. ç·¨è­¯å‰ç«¯è³‡æº
      - name: âš¡ Build Assets
        run: |
          npm install
          npm run build

      # 3.5 æ¸…ç©ºé ç«¯ä¸¦é‡å»ºè³‡æ–™å¤¾çµæ§‹
      - name: ğŸ§¹ Clean remote build assets
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # è¨­å®šè·¯å¾‘
            BUILD_PATH="domains/sienna-beaver-875544.hostingersite.com/laravel_core/public/build"

            # æ¸…ç©ºèˆŠæª”æ¡ˆ
            rm -rf $BUILD_PATH/* || true

            # é‡å»º assets ç›®éŒ„ï¼Œé¿å… FTP 550 éŒ¯èª¤
            mkdir -p $BUILD_PATH/assets

      # 4. FTP åŒæ­¥æª”æ¡ˆ
      - name: ğŸ“‚ Sync files via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: /domains/sienna-beaver-875544.hostingersite.com/laravel_core/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/vendor/**
            .env
            .env.example
            storage/*.key
            tests/**

      # 5. é€é SSH åŸ·è¡Œ Laravel æŒ‡ä»¤
      - name: ğŸš€ Run Commands via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 100s
          script: |
            cd domains/sienna-beaver-875544.hostingersite.com/laravel_core

            # å®‰è£å¥—ä»¶
            composer install --no-dev --optimize-autoloader

            # è³‡æ–™åº«é·ç§»
            php artisan migrate --force

            # æ¸…é™¤ä¸¦é‡å»ºå¿«å–
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
