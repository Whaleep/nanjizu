name: Deploy to Hostinger

on:
  push:
    branches:
      - main  # åªæœ‰æ¨é€åˆ° main åˆ†æ”¯æ™‚æ‰è§¸ç™¼ (è«‹ç¢ºèªæ‚¨çš„åˆ†æ”¯åç¨±æ˜¯ main é‚„æ˜¯ master)

jobs:
  web-deploy:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest

    steps:
      # 1. å–å¾—ç¨‹å¼ç¢¼
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4

      # 2. è¨­å®š PHP ç’°å¢ƒ (ç‚ºäº†è·‘ Composer)
      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2' # è«‹ç¢ºèª Hostinger ä¸Šçš„ PHP ç‰ˆæœ¬
          extensions: mbstring, intl, pdo, pdo_mysql

      # 3. å®‰è£ Composer å¥—ä»¶ (ä¸å«é–‹ç™¼å¥—ä»¶)
      - name: ğŸ“¦ Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

      # 4. è¨­å®š Node.js ç’°å¢ƒ
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 5. ç·¨è­¯å‰ç«¯è³‡æº (Vite)
      - name: âš¡ Build Assets
        run: |
          npm install
          npm run build

      # 6. FTP åŒæ­¥æª”æ¡ˆ (æ ¸å¿ƒæ­¥é©Ÿ)
      # é€™è£¡æœƒæŠŠ build å¥½çš„ vendor å’Œ public/build å…¨éƒ¨å‚³ä¸Šå»
      - name: ğŸ“‚ Sync files via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          # è¦ä¸Šå‚³åˆ° Hostinger çš„å“ªå€‹è³‡æ–™å¤¾ï¼Ÿ
          # è«‹æ ¹æ“šæ‚¨çš„å¯¦éš›è·¯å¾‘ä¿®æ”¹ï¼Œé€šå¸¸æ˜¯ /domains/æ‚¨çš„ç¶²åŸŸ/laravel_core
          server-dir: /domains/sienna-beaver-875544.hostingersite.com/laravel_core/

          # è¦æ’é™¤çš„æª”æ¡ˆ (éå¸¸é‡è¦ï¼ä¸è¦è¦†è“‹ .envï¼Œä¸è¦ä¸Šå‚³ node_modules)
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            .env
            .env.example
            storage/*.key

      # 7. é€é SSH åŸ·è¡Œ Laravel æŒ‡ä»¤ (Migrate & Clear Cache)
      - name: ğŸš€ Run Artisan Commands via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # é€²å…¥æ ¸å¿ƒç›®éŒ„
            cd domains/sienna-beaver-875544.hostingersite.com/laravel_core

            # åŸ·è¡Œé·ç§» (å¼·åˆ¶åŸ·è¡Œï¼Œå› ç‚ºæ˜¯ production)
            php artisan migrate --force

            # æ¸…é™¤ä¸¦é‡å»ºå¿«å–
            php artisan config:clear
            php artisan view:clear
            php artisan route:clear

            # å»ºç«‹ Storage Link (å¦‚æœæ‰äº†çš„è©±è£œé€£ï¼Œæœ‰çš„è©±æœƒç•¥é)
            php artisan storage:link || true
