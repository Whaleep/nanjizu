name: Deploy to Hostinger

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest

    steps:
      # 1. å–å¾—ç¨‹å¼ç¢¼
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4

      # 2. è¨­å®š Node.js ç’°å¢ƒ (ç‚ºäº†ç·¨è­¯ Vite)
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      # 3. ç·¨è­¯å‰ç«¯è³‡æº (Vite)
      # é€™è£¡æˆ‘å€‘åªåšå‰ç«¯ buildï¼Œç”¢ç”Ÿ public/build
      - name: âš¡ Build Assets
        run: |
          npm install
          npm run build

      # === [NEW] æ­¥é©Ÿ 3.5: å…ˆæ¸…ç©ºé ç«¯çš„ build è³‡æ–™å¤¾ ===
      # é€™æ¨£å¯ä»¥ç¢ºä¿èˆŠçš„ js/css æª”æ¡ˆè¢«åˆªé™¤ï¼Œä¸æœƒä½”ç”¨ç©ºé–“
      - name: ğŸ§¹ Clean remote build assets
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # å¼·åˆ¶åˆªé™¤ public/build åº•ä¸‹çš„æ‰€æœ‰æª”æ¡ˆï¼Œä½†ä¿ç•™è³‡æ–™å¤¾æœ¬èº«
            # || true ä»£è¡¨å°±ç®—è³‡æ–™å¤¾ä¸å­˜åœ¨ä¹Ÿä¸è¦å ±éŒ¯åœæ­¢
            rm -rf domains/sienna-beaver-875544.hostingersite.com/laravel_core/public/build/* || true

      # 4. FTP åŒæ­¥æª”æ¡ˆ
      - name: ğŸ“‚ Sync files via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: /domains/sienna-beaver-875544.hostingersite.com/laravel_core/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/vendor/**
            .env
            .env.example
            storage/*.key
            tests/**

      # 5. é€é SSH åŸ·è¡Œ Laravel æŒ‡ä»¤
      - name: ğŸš€ Run Commands via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          # å¢åŠ  timeout æ™‚é–“ï¼Œä»¥å… composer è·‘å¤ªä¹…æ–·ç·š
          timeout: 60s
          script: |
            cd domains/sienna-beaver-875544.hostingersite.com/laravel_core
            composer install --no-dev --optimize-autoloader
            php artisan migrate --force

            # æ¸…é™¤å¿«å– (Inertia é–‹ç™¼è€…å»ºè­°ï¼šéƒ¨ç½²å¾Œæœ€å¥½é‡å•Ÿ queue æˆ–æ¸…ç©ºå¿«å–)
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan storage:link || true
