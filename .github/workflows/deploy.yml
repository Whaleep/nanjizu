name: Deploy to Hostinger

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest

    steps:
      # 1. å–å¾—ç¨‹å¼ç¢¼
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4

      # 2. è¨­å®š Node.js ç’°å¢ƒ
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      # 3. ç·¨è­¯å‰ç«¯è³‡æº (åŒ…å«ä¿®æ­£ .gitignore)
      - name: âš¡ Build Assets
        run: |
          npm install
          npm run build
          # å¼·åˆ¶è®“ FTP Action çœ‹å¾—è¦‹ build è³‡æ–™å¤¾ (é‡è¦ï¼)
          sed -i '/public\/build/d' .gitignore

      # 3.5 æ¸…ç©ºé ç«¯ build è³‡æ–™å¤¾
      - name: ğŸ§¹ Clean remote build assets
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # åˆªé™¤ build è³‡æ–™å¤¾ä¸‹çš„æ‰€æœ‰å…§å®¹ï¼Œä½†ä¿ç•™è³‡æ–™å¤¾æœ¬èº«
            # é€™è£¡çš„è·¯å¾‘è«‹ç¢ºä¿èˆ‡æ‚¨çš„ Hostinger çµæ§‹ä¸€è‡´
            rm -rf domains/sienna-beaver-875544.hostingersite.com/laravel_core/public/build/* || true

      # 4. FTP åŒæ­¥æª”æ¡ˆ
      - name: ğŸ“‚ Sync files via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: /domains/sienna-beaver-875544.hostingersite.com/laravel_core/
          # å› ç‚ºæˆ‘å€‘åœ¨ Step 3 ä¿®æ”¹äº† .gitignoreï¼Œé€™è£¡ä¸éœ€è¦é¡å¤–è¨­å®š include
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/vendor/**
            .env
            .env.example
            storage/*.key
            tests/**

      # 5. é€é SSH åŸ·è¡Œ Laravel æŒ‡ä»¤
      - name: ğŸš€ Run Commands via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 100s
          script: |
            cd domains/sienna-beaver-875544.hostingersite.com/laravel_core

            # å®‰è£å¥—ä»¶
            composer install --no-dev --optimize-autoloader

            # è³‡æ–™åº«é·ç§»
            php artisan migrate --force

            # æ¸…é™¤ä¸¦é‡å»ºå¿«å– (é€™å° Inertia/Vite å¾ˆé‡è¦)
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # ç¢ºä¿ Storage Link å­˜åœ¨ (å¦‚æœæœ‰ç§»å‹•è³‡æ–™å¤¾çµæ§‹ï¼Œæœ‰æ™‚éœ€è¦æ‰‹å‹•å»ºï¼Œä½†é€šå¸¸è·‘ä¸€æ¬¡å°±å¥½)
            # php artisan storage:link || true
